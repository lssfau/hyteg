###############################################################################
##                                                                           ##
##    Genral settings                                                        ##
##                                                                           ##
###############################################################################

stages:
   - pretest
   - test
   - benchmark
   - no_werror

variables:
   GIT_SUBMODULE_STRATEGY: normal

###############################################################################
##                                                                           ##
##    Build templates                                                        ##
##                                                                           ##
###############################################################################

.build_template:
   script:
      - rm -rf /usr/include/boost /opt/boost
      - export
      - export NUM_CORES=$(nproc --all)
      - export MAX_BUILD_CORES=$(( $(awk '( $1 == "MemTotal:" ) { print $2 }' /proc/meminfo) / ( 4 * 1024 * 1024  ) ))
      - "[[ $MAX_BUILD_CORES -lt $NUM_CORES ]] && export MAX_BUILD_CORES=$MAX_BUILD_CORES || export MAX_BUILD_CORES=$NUM_CORES"
      - echo "NUM_CORES = $NUM_CORES - MAX_BUILD_CORES =  $MAX_BUILD_CORES"
      - /opt/view/bin/cmake --version
      - ccache --version
      - mpirun --version
      - export CCACHE_BASEDIR=$CI_PROJECT_DIR
      - mkdir $CI_PROJECT_DIR/build
      - cd $CI_PROJECT_DIR/build
      - if dpkg --compare-versions `ompi_info | head -2 | tail -1 | sed 's/[^0-9.]*\([0-9.]*\).*/\1/'` ge 1.10; then export MPIEXEC_PREFLAGS="--allow-run-as-root" ; fi
      - /opt/view/bin/cmake ..
         -DWARNING_ERROR=$WARNING_ERROR
         -DWALBERLA_DOUBLE_ACCURACY=$WALBERLA_DOUBLE_ACCURACY
         -DWALBERLA_BUILD_WITH_MPI=$WALBERLA_BUILD_WITH_MPI
         -DWALBERLA_BUILD_WITH_OPENMP=$WALBERLA_BUILD_WITH_OPENMP
         -DWALBERLA_BUILD_WITH_METIS=$WALBERLA_BUILD_WITH_METIS
         -DWALBERLA_BUILD_WITH_PARMETIS=$WALBERLA_BUILD_WITH_PARMETIS
         -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE
         -DMPIEXEC_PREFLAGS=$MPIEXEC_PREFLAGS
         -DHYTEG_BUILD_WITH_PETSC=$HYTEG_BUILD_WITH_PETSC
         -DPETSC_DIR=$PETSC_DIR
        -DHYTEG_BUILD_WITH_TRILINOS=$HYTEG_BUILD_WITH_TRILINOS
        -DHYTEG_TERRANEO_MODULE=$HYTEG_TERRANEO_MODULE
        -DHYTEG_DOWNLOAD_BOOST=$HYTEG_DOWNLOAD_BOOST
        -DWALBERLA_SANITIZE_ADDRESS=$WALBERLA_SANITIZE_ADDRESS
        -DWALBERLA_SANITIZE_UNDEFINED=$WALBERLA_SANITIZE_UNDEFINED
        -DWALBERLA_OPTIMIZE_FOR_LOCALHOST=$WALBERLA_OPTIMIZE_FOR_LOCALHOST
      - cmake . -LA
      - cd $CI_PROJECT_DIR/build/apps
      - make -j $MAX_BUILD_CORES -l $NUM_CORES
      - ctest -C $CMAKE_BUILD_TYPE --output-on-failure -j $NUM_CORES
      - cd $CI_PROJECT_DIR/build/tests
      - make -j $MAX_BUILD_CORES -l $NUM_CORES
      - ctest -LE $CTEST_EXCLUDE_LABELS -C $CMAKE_BUILD_TYPE --output-on-failure -j NUM_CORES
      - cd $CI_PROJECT_DIR/build/tutorials
      - make -j $MAX_BUILD_CORES -l $NUM_CORES
   tags:
      - docker
# these are the defaults which will be overwritten with the extends keyword
   variables:
     CTEST_EXCLUDE_LABELS: "longrun"
     WALBERLA_BUILD_WITH_MPI: "ON"
     WALBERLA_BUILD_WITH_OPENMP: "OFF"
     OMP_NUM_THREADS: "4"
     OMP_WAIT_POLICY: "PASSIVE"
     CMAKE_BUILD_TYPE: "Release"
     HYTEG_TERRANEO_MODULE: "OFF"
     WALBERLA_BUFFER_DEBUG: "OFF"
     WALBERLA_DOUBLE_ACCURACY: "ON"
     WALBERLA_BUILD_WITH_METIS: "ON"
     WALBERLA_BUILD_WITH_PARMETIS: "ON"
     WALBERLA_OPTIMIZE_FOR_LOCALHOST: "OFF"
     WARNING_ERROR: "ON"


###############################################################################
##                                                                           ##
##    Linux builds                                                           ##
##                                                                           ##
###############################################################################



gcc_11_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

gcc_11_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

gcc_11_serial_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11
   stage: pretest
   before_script:
      - sed -i 's/-Wno-error=\(.*\)conversion/-Wno-\1conversion/g' $CI_PROJECT_DIR/CMakeLists.txt
   variables:
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

gcc_11_mpionly_dbg_petsc-complex_trilinos:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11
   stage: pretest
   variables:
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

gcc_11_mpionly_petsc_trilinos:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-11
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

gcc_12_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

gcc_12_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

gcc_12_serial_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12
   stage: pretest
   before_script:
      - sed -i 's/-Wno-error=\(.*\)conversion/-Wno-\1conversion/g' $CI_PROJECT_DIR/CMakeLists.txt
   variables:
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

gcc_12_mpionly_dbg_petsc-complex_trilinos:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12
   stage: pretest
   variables:
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

gcc_12_mpionly_petsc_trilinos:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

gcc_12_mpionly_eigen_petsc_trilinos_no_werror:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/gcc-12
   stage: no_werror
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      WARNING_ERROR: "OFF"
   when: manual
   needs: [ ]
   tags:
      - docker

clang_13_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-13
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_13_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-13
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_13_serial_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-13
   stage: pretest
   before_script:
      - sed -i 's/-Wno-error=\(.*\)conversion/-Wno-\1conversion/g' $CI_PROJECT_DIR/CMakeLists.txt
   variables:
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_13_mpionly_dbg_petsc-complex_trilinos:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-13
   stage: pretest
   variables:
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_13_mpionly_petsc_trilinos:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-13
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_14_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-14
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_14_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-14
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_14_serial_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-14
   stage: pretest
   before_script:
      - sed -i 's/-Wno-error=\(.*\)conversion/-Wno-\1conversion/g' $CI_PROJECT_DIR/CMakeLists.txt
   variables:
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_14_mpionly_dbg_petsc-complex_trilinos:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-14
   stage: pretest
   variables:
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_14_mpionly_petsc_trilinos:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-14
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_15_serial:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-15
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_15_mpionly:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-15
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_15_serial_dbg_sp:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-15
   stage: pretest
   before_script:
      - sed -i 's/-Wno-error=\(.*\)conversion/-Wno-\1conversion/g' $CI_PROJECT_DIR/CMakeLists.txt
   variables:
      WALBERLA_BUILD_WITH_MPI: "OFF"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_DOUBLE_ACCURACY: "OFF"
      WALBERLA_BUILD_WITH_PARMETIS: "OFF"
      WALBERLA_BUILD_WITH_METIS: "OFF"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_15_mpionly_dbg_petsc-complex_trilinos:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-15
   stage: pretest
   variables:
      CMAKE_BUILD_TYPE: "DebugOptimized"
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_15_mpionly_petsc_trilinos:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-15
   stage: pretest
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      HYTEG_TERRANEO_MODULE: "ON"
      HYTEG_DOWNLOAD_BOOST: "ON"
   tags:
      - docker

clang_15_mpionly_eigen_petsc_trilinos_no_werror:
   extends: .build_template
   image: i10git.cs.fau.de:5005/walberla/buildenvs/clang-15
   stage: no_werror
   variables:
      WALBERLA_BUILD_WITH_OPENMP: "OFF"
      HYTEG_BUILD_WITH_PETSC: "ON"
      HYTEG_BUILD_WITH_TRILINOS: "ON"
      PETSC_DIR: "/opt/spack/install"
      WARNING_ERROR: "OFF"
   when: manual
   needs: [ ]
   tags:
      - docker